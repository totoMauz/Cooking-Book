<!DOCTYPE html>
<html lang="en">
<style>
  body,
  .delete,
  .input,
  .add {
    font-size: 4rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    color: oldlace;
    background-color: slategrey;
  }

  h3 {
    font-size: 2rem;
  }

  .content li,
  .input,
  .add {
    border-radius: 0.5rem;
  }

  .content li,
  .input {
    width: 30rem;
  }

  .content h2 {
    margin-top: 1rem;
    margin-bottom: 0rem;
  }

  .content {
    padding-left: 2rem;
  }

  .content ul {
    margin-top: 0rem;
    list-style-type: none;
  }

  .content li {
    padding-left: 0.5rem;
    margin-top: 0.5rem;
    color: black;
  }

  .content li:nth-child(even) {
    background-color: #006363;
  }

  .content li:nth-child(odd) {
    background-color: #009999;
  }

  .delete {
    color: #A60000;
    margin-left: 1rem;
    background: transparent;
    border: 0rem;
  }

  .control {
    margin-bottom: 4rem;
    display: inline-flex;
    padding-left: 5rem;
  }
</style>

<head>
  <meta charset="utf-8">
  <title>Einkaufsliste</title>
</head>

<body onload="getShoppingList();getAllIngredients();">
  <section class="header" id="header">
    <h1>Einkaufsliste</h1>
  </section>
  <section class="control" id="control">
    <input class="input" type="text" id="newIngredient" list="ingredients" />
    <datalist id="ingredients"></datalist>
  </section>
  <button onclick="addIngredient()" class="add">Hinzuf√ºgen</button>
  <section class="content" id="content"></section>
</body>

<script language="javascript">

  function cleanContent() {
    return Promise.resolve().then(() => {
      const oContent = document.getElementById("content");
      while (oContent.firstChild) {
        oContent.removeChild(oContent.firstChild);
      }
    });
  }

  function cleanOptions() {
    return Promise.resolve().then(() => {
      const oIngredients = document.getElementById("ingredients");
      while (oIngredients.children.length > 0) {
        oIngredients.children[0].remove();
      }
    });
  }

  function deleteData(sUrl, sData) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("DELETE", `${sUrl}/${sData}`, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function putData(sUrl, sData) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("PUT", `${sUrl}/${sData}`, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function getQuery(sUrl) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("GET", sUrl, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function getAllIngredients() {
    return cleanOptions()
      .then(() => { return getQuery("/ingredient") })
      .then((ingredients) => {
        const oIngredients = document.getElementById("ingredients");
        ingredients.forEach((i) => {
          const oOption = document.createElement('option');
          oOption.value = i.name;
          oIngredients.appendChild(oOption);
        });
      });
  }

  function displayShoppingList(shoppingList) {
    const oContent = document.getElementById("content");
    let oNewContent = [];
    return Promise.resolve().then(() => {

      Object.keys(shoppingList).forEach((store) => {
        if (store !== "Any") {
          const oStoreHeader = document.createElement('h2');
          oStoreHeader.innerText = store;
          oNewContent.push(oStoreHeader);
        }
        Object.keys(shoppingList[store]).forEach((category) => {
          const oList = document.createElement('ul');
          oNewContent.push(oList);

          shoppingList[store][category].forEach((item) => {
            const oItem = document.createElement('li');
            oItem.setAttribute("id", `li_${item.name}`);

            if (item.amount) {
              oItem.appendChild(document.createTextNode(`${item.name}: ${item.amount}`));
            } else {
              oItem.appendChild(document.createTextNode(item.name));
            }
            oList.appendChild(oItem);

            const oButton = document.createElement('button');
            oButton.setAttribute("id", item.name);
            oButton.className = "delete";
            oButton.innerText = 'X';
            oButton.onclick = removeIngredient.bind(this, item.name);
            oItem.appendChild(oButton);
          });
        });

        oNewContent.push(document.createElement("hr"));
      });
    })
      .catch((err) => {
        oNewContent = document.createElement('span');
        oNewContent.innerText = err;
      }).finally(() => {
        if (Array.isArray(oNewContent)) {
          oNewContent.forEach((newContent) => {
            oContent.appendChild(newContent);
          });
        }
        else {
          oContent.appendChild(oNewContent);
        }
      });
  }

  function getShoppingList() {
    return cleanContent()
      .then(() => { return getQuery("/shopping_list"); })
      .then((shoppingList) => { return displayShoppingList(shoppingList); })
  }

  function addIngredient() {
    const oIngredient = document.getElementById("newIngredient");
    const sInput = oIngredient.value;

    return cleanContent()
      .then(() => { return putData("ingredient", sInput); })
      .then((shoppingList) => { displayShoppingList(shoppingList); })
      .then(() => { return getAllIngredients(); });
  }

  function removeIngredient(sIngredient) {
    const iPosition = document.documentElement.scrollTop || document.body.scrollTop;
    return cleanContent()
      .then(() => { return deleteData("ingredient", sIngredient); })
      .then((shoppingList) => { displayShoppingList(shoppingList); })
      .then(() => { 
        return getAllIngredients(); 
      }).finally(() => {
        window.scrollTo(0, iPosition);
      });
  }

</script>

</html>