<!DOCTYPE html>
<html lang="en">
<style>
  :root {
    --color-1: #5AA8AD;
    --color-2: #6492A0;

    --color-bg-1: #959b9c;
    --color-font-bg-1: #202020;

    --color-bg-2: #F4F3F5;
    --color-font-bg-2: #202020;
  }

  body,
  .delete,
  .input,
  button {
    font-size: 1.4rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .header {
    width: 100%;
    display: flex;
  }

  body {
    color: var(--color-font-bg-1);
    background-color: var(--color-bg-1);
  }

  .header,
  .content li,
  .input,
  button {
    color: var(--color-font-bg-2);
    background-color: var(--color-bg-2);
    border-radius: 0.5rem;
  }

  .content li,
  .input {
    width: 14rem;
  }

  .content h1 {
    margin-top: 1rem;
    margin-bottom: 0rem;
  }

  .content ul {
    margin-top: 0rem;
    padding-left: 0rem;
    list-style-type: none;
  }

  .content li {
    margin-top: 0.5rem;
    color: black;
    cursor: move;
  }

  .content li:nth-child(even) {
    background-color: var(--color-1);
  }

  .content li:nth-child(odd) {
    background-color: var(--color-2);
  }

  .delete {
    color: #A60000;
    margin-left: 1rem;
    background: transparent;
    border: 0rem;
  }

  .control {
    margin-bottom: 4rem;
    display: inline-flex;
  }

  .header {
    overflow: hidden;
    margin-bottom: 4rem;
  }

  .header button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    transition: 0.3s;
  }

  .header button:hover {
    background-color: var(--color-2);
  }

  .header button.active {
    background-color: var(--color-1);
  }
</style>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="Description" content="Shopping list with some admin areas to configure ingredients or recipes">
  <title>Einkaufsliste</title>
  <link rel=icon href=favicon.png sizes="50x50" type="image/png">
</head>

<body onload="showShoppingList()">
  <nav class="header" id="header">
    <button id="btnShoppingList" class="tablinks" onclick="showShoppingList()" accesskey="e">Einkaufsliste</button>
    <button id="btnRecipes" class="tablinks" onclick="showRecipes()" accesskey="r">Rezepte</button>
    <button id="btnIngredients" class="tablinks" onclick="showIngredients()" accesskey="z">Zutaten</button>
  </nav>

  <!-- Used by both ShopplingList and Ingredients -->
  <section id="shoppingList">
    <section class="control" id="control">
      <input class="input" type="text" id="newIngredient" list="dl_ingredients" />
      <datalist id="dl_ingredients"></datalist>
    </section>
    <button onclick="addIngredient()">+</button>
  </section>

  <section class="content" id="c_recipes"></section>
  <section class="content" id="c_ingredients"></section>
  <section class="content" id="c_shoppingList"></section>
</body>

<script language="javascript">

  let aGroups;
  let aStores;

  function showShoppingList() {
    deactivateAllTabs();
    hideElements(["c_recipes", "c_ingredients"]);
    document.getElementById("btnShoppingList").className += " active";
    document.getElementById("btnShoppingList").style.width = "40%";
    cleanContent("c_shoppingList");
    showElement(["c_shoppingList", "shoppingList"]);
    return getShoppingList()
      .then(() => {
        return getAllIngredients();
      });
  }

  function showRecipes() {
    deactivateAllTabs();
    hideElements(["c_shoppingList", "c_ingredients", "shoppingList"]);
    document.getElementById("btnRecipes").className += " active";
    document.getElementById("btnRecipes").style.width = "40%";
    cleanContent("c_recipes");
    showElement(["c_recipes"]);
  }

  function showIngredients() {
    deactivateAllTabs();
    hideElements(["c_shoppingList", "c_recipes"]);
    document.getElementById("btnIngredients").className += " active";
    document.getElementById("btnIngredients").style.width = "40%";
    cleanContent("c_ingredients");
    showElement(["c_ingredients", "shoppingList"]);

    const oContent = document.getElementById("c_ingredients");
    let oNewContent = [];

    return getAllStores()
      .then(() => {
        return getAllGroups();
      }).then(() => {
        return getQuery("/ingredient")
      })
      .then((ingredients) => {

        let oList = document.createElement("ul");

        ingredients.forEach((ingredient) => {
          let oIngredient = document.createElement("li");

          let oName = document.createElement("span");
          oName.innerText = ingredient.name;

          oIngredient.appendChild(oName);


          oList.appendChild(oIngredient);
        });

        oNewContent.push(oList);
      })
      .catch((err) => {
        oNewContent = document.createElement('span');
        oNewContent.innerText = err;
      })
      .finally(() => {
        if (Array.isArray(oNewContent)) {
          oNewContent.forEach((newContent) => {
            oContent.appendChild(newContent);
          });
        }
        else {
          oContent.appendChild(oNewContent);
        }
      });
  }

  function deactivateAllTabs() {
    const aTabs = document.getElementsByClassName("tablinks");
    for (let oTab of aTabs) {
      oTab.className = oTab.className.replace(" active", "");
      oTab.style.width = "30%";
    };
  }

  function hideElements(aId) {
    aId.forEach((sId) => {
      document.getElementById(sId).style.display = "none";
    });
  }

  function showElement(aId) {
    aId.forEach((sId) => {
      document.getElementById(sId).style.display = "block";
    });
  }

  function cleanContent(sId) {
    const oContent = document.getElementById(sId);
    while (oContent.firstChild) {
      oContent.removeChild(oContent.firstChild);
    }
  }

  function cleanOptions() {
    const oIngredients = document.getElementById("dl_ingredients");
    while (oIngredients.children.length > 0) {
      oIngredients.children[0].remove();
    }
  }

  function deleteData(sUrl, sData) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("DELETE", `${sUrl}/${sData}`, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function putData(sUrl, sData) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("PUT", `${sUrl}/${sData}`, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function getQuery(sUrl) {
    return new Promise((resolve, reject) => {
      const xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = () => {
        if (xmlHttp.readyState == 4) {
          if (xmlHttp.status == 200) {
            resolve(JSON.parse(xmlHttp.response));
          }
          else {
            reject(xmlHttp.responseText);
          }
        }
      }
      xmlHttp.open("GET", sUrl, true);
      xmlHttp.setRequestHeader("Content-Type", "application/json");
      xmlHttp.send(null);
    });
  }

  function getAllStores() {
    if (!aStores) {
      return getQuery("/store")
        .then((data) => {
          aStores = data.stores;
          return aStores;
        });
    }
    return Promise.resolve(aStores);
  }

  function getAllGroups() {
    if (!aGroups) {
      return getQuery("/group")
        .then((data) => {
          aGroups = data.groups;
          return aGroups;
        });
    }
    return Promise.resolve(aGroups);
  }

  function getAllIngredients() {
    cleanOptions();
    return getQuery("/ingredient")
      .then((ingredients) => {
        const oIngredients = document.getElementById("dl_ingredients");
        ingredients.forEach((i) => {
          const oOption = document.createElement('option');
          oOption.value = i.name;
          oIngredients.appendChild(oOption);
        });
      });
  }

  function displayShoppingList(shoppingList) {
    const oContent = document.getElementById("c_shoppingList");
    let oNewContent = [];
    return Promise.resolve().then(() => {

      Object.keys(shoppingList).forEach((store) => {
        if (store !== "Any") {
          const oStoreHeader = document.createElement('h1');
          oStoreHeader.innerText = store;
          oNewContent.push(oStoreHeader);
        }
        Object.keys(shoppingList[store]).forEach((category) => {
          const oList = document.createElement('ul');
          oNewContent.push(oList);

          shoppingList[store][category].forEach((item) => {
            const oItem = document.createElement('li');
            oItem.setAttribute("id", `li_${item.name}`);
            oItem.setAttribute("draggable", true);

            if (item.amount) {
              oItem.appendChild(document.createTextNode(`${item.name}: ${item.amount}`));
            } else {
              oItem.appendChild(document.createTextNode(item.name));
            }
            oItem.addEventListener('dragstart', handleDragStart, false);
            oItem.addEventListener('dragend', handleDragEnd, false);

            oItem.addEventListener('touchstart', handleTouchStart, { passive: true });
            oItem.addEventListener('touchmove', handleTouchMove, { passive: true });
            oItem.addEventListener('touchend', handleTouchEnd, { passive: true });

            oList.appendChild(oItem);

            const oButton = document.createElement('button');
            oButton.setAttribute("id", item.name);
            oButton.className = "delete";
            oButton.innerText = 'X';

            oButton.addEventListener('click', () => { removeIngredient(item.name) }, false);
            oItem.appendChild(oButton);
          });
        });

        oNewContent.push(document.createElement("hr"));
      });
    })
      .catch((err) => {
        oNewContent = document.createElement('span');
        oNewContent.innerText = err;
      }).finally(() => {
        if (Array.isArray(oNewContent)) {
          oNewContent.forEach((newContent) => {
            oContent.appendChild(newContent);
          });
        }
        else {
          oContent.appendChild(oNewContent);
        }
      });
  }

  function getShoppingList() {
    cleanContent("c_shoppingList");
    return getQuery("/shopping_list")
      .then((shoppingList) => { return displayShoppingList(shoppingList); })
  }

  function addIngredient() {
    const oIngredient = document.getElementById("newIngredient");
    const sInput = oIngredient.value;

    cleanContent("c_shoppingList");
    return putData("ingredient", sInput)
      .then((shoppingList) => { displayShoppingList(shoppingList); })
      .then(() => { return getAllIngredients(); });
  }

  function removeIngredient(sIngredient) {
    const iPosition = document.documentElement.scrollTop || document.body.scrollTop;
    cleanContent("c_shoppingList");
    return deleteData("ingredient", sIngredient)
      .then((shoppingList) => { displayShoppingList(shoppingList); })
      .then(() => {
        return getAllIngredients();
      }).finally(() => {
        window.scrollTo(0, iPosition);
      });
  }

  const DELTA = 100;
  let iX = 0;
  function handleDragStart(e) {
    iX = e.clientX;
    e.target.style.opacity = "0.4";
  }

  function handleDragEnd(e) {
    if (Math.abs(iX - e.clientX) > DELTA) {
      const sId = e.target.id;
      if (sId.startsWith("li_")) {
        removeIngredient(sId.substr(3));
      }
    }
    else {
      e.target.style.opacity = "1";
    }
    iX = 0;
  }

  function handleTouchStart(e) {
    iX = e.targetTouches[0].pageX;
    e.target.style.opacity = "0.4";
  }

  function handleTouchMove(e) {
    const touchLocation = e.targetTouches[0];
    e.target.style.left = touchLocation.pageX + 'px';
    e.target.style.top = touchLocation.pageY + 'px';
  }

  function handleTouchEnd(e) {
    if (Math.abs(iX - e.changedTouches[0].screenX) > DELTA) {
      const sId = e.target.id;
      if (sId.startsWith("li_")) {
        removeIngredient(sId.substr(3));
      }
    }
    else {
      e.target.style.opacity = "1";
    }
    iX = 0;
  }

</script>

</html>